<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menú de Delicias</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/react@18/umd/react.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/babel-standalone@7/babel.min.js"></script>
</head>
<body class="bg-gray-100">
  <div id="root"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [products, setProducts] = useState([]);
      const [cart, setCart] = useState([]);
      const [name, setName] = useState('');
      const [address, setAddress] = useState('');
      const [showCart, setShowCart] = useState(false);
      const [isAdmin, setIsAdmin] = useState(false);
      const [password, setPassword] = useState('');
      const [newProduct, setNewProduct] = useState({ name: '', description: '', price: '', category: '' });
      const [isClosed, setIsClosed] = useState(false);

      // Verificar si los pedidos están cerrados
      useEffect(() => {
        const checkClosed = () => {
          const now = new Date();
          const day = now.getDay(); // 0=Domingo, 1=Lunes, ..., 4=Jueves
          const hours = now.getHours();
          const minutes = now.getMinutes();
          // Cierra pedidos el jueves a las 10:00 a.m.
          if (day === 4 && (hours > 10 || (hours === 10 && minutes >= 0))) {
            setIsClosed(true);
          } else if (day > 4 || day < 3) { // Viernes en adelante o antes de miércoles
            setIsClosed(true);
          } else {
            setIsClosed(false);
          }
        };
        checkClosed();
        const interval = setInterval(checkClosed, 60000); // Verifica cada minuto
        return () => clearInterval(interval);
      }, []);

      // Obtener productos
      useEffect(() => {
        fetch('/api/products')
          .then(res => res.json())
          .then(data => setProducts(data))
          .catch(err => console.error('Error fetching products:', err));
      }, []);

      // Agregar al carrito
      const addToCart = (product) => {
        const existing = cart.find(item => item.id === product.id);
        if (existing) {
          setCart(cart.map(item =>
            item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item
          ));
        } else {
          setCart([...cart, { ...product, quantity: 1 }]);
        }
      };

      // Eliminar del carrito
      const removeFromCart = (id) => {
        setCart(cart.filter(item => item.id !== id));
      };

      // Cambiar cantidad
      const updateQuantity = (id, quantity) => {
        if (quantity < 1) return removeFromCart(id);
        setCart(cart.map(item =>
          item.id === id ? { ...item, quantity } : item
        ));
      };

      // Calcular total
      const total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

      // Enviar pedido por WhatsApp
      const sendOrder = () => {
        if (!name || !address || cart.length === 0) {
          alert('Por favor, completa el nombre, dirección y agrega productos al carrito.');
          return;
        }
        const orderDetails = cart.map(item =>
          `${item.quantity}x ${item.name} - $${(item.price * item.quantity).toFixed(2)}`
        ).join('\n');
        const message = `Nuevo pedido de ${name}\nDirección: ${address}\n\n${orderDetails}\n\nTotal: $${total.toFixed(2)}`;
        const whatsappUrl = `https://wa.me/+521234567890?text=${encodeURIComponent(message)}`; // Cambia por el número de tu tía
        window.open(whatsappUrl, '_blank');
        setCart([]);
        setName('');
        setAddress('');
        setShowCart(false);
      };

      // Iniciar sesión como admin
      const login = () => {
        if (password === 'admin123') { // Cambia esta contraseña
          setIsAdmin(true);
        } else {
          alert('Contraseña incorrecta');
        }
      };

      // Agregar nuevo producto
      const addProduct = async () => {
        if (!newProduct.name || !newProduct.price || !newProduct.category) {
          alert('Por favor, completa todos los campos.');
          return;
        }
        try {
          const response = await fetch('/api/products', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(newProduct)
          });
          if (response.ok) {
            const addedProduct = await response.json();
            setProducts([...products, addedProduct]);
            setNewProduct({ name: '', description: '', price: '', category: '' });
          } else {
            alert('Error al agregar producto');
          }
        } catch (err) {
          console.error(err);
          alert('Error en el servidor');
        }
      };

      // Eliminar producto
      const deleteProduct = async (id) => {
        try {
          const response = await fetch(`/api/products/${id}`, {
            method: 'DELETE'
          });
          if (response.ok) {
            setProducts(products.filter(product => product.id !== id));
          } else {
            alert('Error al eliminar producto');
          }
        } catch (err) {
          console.error(err);
          alert('Error en el servidor');
        }
      };

      if (isAdmin) {
        return (
          <div className="container mx-auto p-4 max-w-md">
            <h1 className="text-2xl font-bold text-center mb-4">Administrar Menú</h1>
            <button
              onClick={() => setIsAdmin(false)}
              className="mb-4 bg-red-500 text-white px-4 py-2 rounded"
            >
              Cerrar sesión
            </button>
            <div className="bg-white p-4 rounded-lg shadow mb-4">
              <h2 className="text-xl font-semibold mb-2">Agregar Producto</h2>
              <input
                type="text"
                placeholder="Nombre"
                value={newProduct.name}
                onChange={(e) => setNewProduct({ ...newProduct, name: e.target.value })}
                className="w-full p-2 mb-2 border rounded"
              />
              <input
                type="text"
                placeholder="Descripción"
                value={newProduct.description}
                onChange={(e) => setNewProduct({ ...newProduct, description: e.target.value })}
                className="w-full p-2 mb-2 border rounded"
              />
              <input
                type="number"
                placeholder="Precio"
                value={newProduct.price}
                onChange={(e) => setNewProduct({ ...newProduct, price: e.target.value })}
                className="w-full p-2 mb-2 border rounded"
              />
              <select
                value={newProduct.category}
                onChange={(e) => setNewProduct({ ...newProduct, category: e.target.value })}
                className="w-full p-2 mb-2 border rounded"
              >
                <option value="">Selecciona categoría</option>
                <option value="Platillos">Platillos</option>
                <option value="Bebidas">Bebidas</option>
                <option value="Postres">Postres</option>
              </select>
              <button
                onClick={addProduct}
                className="w-full bg-green-500 text-white p-2 rounded"
              >
                Agregar
              </button>
            </div>
            <h2 className="text-xl font-semibold mb-2">Productos</h2>
            {products.map(product => (
              <div key={product.id} className="bg-white p-2 rounded-lg shadow mb-2 flex justify-between">
                <div>
                  <p>{product.name} - ${product.price}</p>
                  <p className="text-sm text-gray-600">{product.category}</p>
                </div>
                <button
                  onClick={() => deleteProduct(product.id)}
                  className="bg-red-500 text-white px-2 py-1 rounded"
                >
                  Eliminar
                </button>
              </div>
            ))}
          </div>
        );
      }

      if (isClosed) {
        return (
          <div className="container mx-auto p-4 max-w-md text-center">
            <h1 className="text-2xl font-bold mb-4">Pedidos Cerrados</h1>
            <p>Los pedidos se abren nuevamente el próximo miércoles.</p>
            <button
              onClick={() => setPassword('')}
              className="mt-4 bg-blue-500 text-white px-4 py-2 rounded"
            >
              Administrar Menú
            </button>
            {password !== '' && (
              <div className="mt-4">
                <input
                  type="password"
                  placeholder="Contraseña"
                  value={password}
                  onChange={(e) => setPassword(e.target.value)}
                  className="w-full p-2 mb-2 border rounded"
                />
                <button
                  onClick={login}
                  className="w-full bg-blue-500 text-white p-2 rounded"
                >
                  Iniciar Sesión
                </button>
              </div>
            )}
          </div>
        );
      }

      return (
        <div className="container mx-auto p-4 max-w-md">
          <h1 className="text-2xl font-bold text-center mb-4">Menú de Delicias</h1>
          
          {!showCart && (
            <div>
              {['Platillos', 'Bebidas', 'Postres'].map(category => (
                <div key={category}>
                  <h2 className="text-xl font-semibold mt-4">{category}</h2>
                  {products.filter(p => p.category === category).map(product => (
                    <div key={product.id} className="bg-white p-4 rounded-lg shadow mb-2">
                      <h3 className="text-lg font-semibold">{product.name}</h3>
                      <p className="text-gray-600 text-sm">{product.description}</p>
                      <p className="text-lg font-bold">${product.price.toFixed(2)}</p>
                      <button
                        onClick={() => addToCart(product)}
                        className="mt-2 bg-blue-500 text-white px-4 py-2 rounded w-full"
                      >
                        Agregar
                      </button>
                    </div>
                  ))}
                </div>
              ))}
              <button
                onClick={() => setPassword('')}
                className="mt-4 bg-gray-500 text-white px-4 py-2 rounded w-full"
              >
                Administrar Menú
              </button>
              {password !== '' && (
                <div className="mt-4">
                  <input
                    type="password"
                    placeholder="Contraseña"
                    value={password}
                    onChange={(e) => setPassword(e.target.value)}
                    className="w-full p-2 mb-2 border rounded"
                  />
                  <button
                    onClick={login}
                    className="w-full bg-blue-500 text-white p-2 rounded"
                  >
                    Iniciar Sesión
                  </button>
                </div>
              )}
            </div>
          )}

          {showCart && (
            <div className="bg-white p-4 rounded-lg shadow">
              <h2 className="text-xl font-bold mb-4">Carrito</h2>
              {cart.length === 0 ? (
                <p>El carrito está vacío.</p>
              ) : (
                <>
                  {cart.map(item => (
                    <div key={item.id} className="flex justify-between items-center mb-2">
                      <div>
                        <p>{item.name} x {item.quantity}</p>
                        <p>${(item.price * item.quantity).toFixed(2)}</p>
                      </div>
                      <div className="flex items-center">
                        <button
                          onClick={() => updateQuantity(item.id, item.quantity - 1)}
                          className="bg-gray-300 px-2 py-1 rounded"
                        >
                          -
                        </button>
                        <span className="mx-2">{item.quantity}</span>
                        <button
                          onClick={() => updateQuantity(item.id, item.quantity + 1)}
                          className="bg-gray-300 px-2 py-1 rounded"
                        >
                          +
                        </button>
                        <button
                          onClick={() => removeFromCart(item.id)}
                          className="ml-2 bg-red-500 text-white px-2 py-1 rounded"
                        >
                          Eliminar
                        </button>
                      </div>
                    </div>
                  ))}
                  <p className="text-xl font-bold mt-4">Total: ${total.toFixed(2)}</p>
                  <div className="mt-4">
                    <input
                      type="text"
                      placeholder="Nombre"
                      value={name}
                      onChange={(e) => setName(e.target.value)}
                      className="w-full p-2 mb-2 border rounded"
                    />
                    <input
                      type="text"
                      placeholder="Dirección"
                      value={address}
                      onChange={(e) => setAddress(e.target.value)}
                      className="w-full p-2 mb-2 border rounded"
                    />
                    <button
                      onClick={sendOrder}
                      className="w-full bg-green-500 text-white p-2 rounded"
                    >
                      Enviar por WhatsApp
                    </button>
                  </div>
                </>
              )}
            </div>
          )}

          <button
            onClick={() => setShowCart(!showCart)}
            className="fixed bottom-4 right-4 bg-blue-500 text-white p-3 rounded-full shadow-lg"
          >
            {showCart ? 'Menú' : `Carrito (${cart.length})`}
          </button>
        </div>
      );
    };

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
</body>
</html>